<html>
    <head>
    <title>End-to-end Encryption - Scuttlebot - SSBC</title>
    <link rel="stylesheet" href="/normalize.css">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/atelier-forest-light.css">
    <script src="/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
    <body>
      <div id="topnav">
    <div id="topnav-inner">
      <a class="topnav-item " href="/" title="Home">
      Home<br><small>SSBC</small>
    </a>
      <a class="topnav-item " href="/patchwork" title="Patchwork">
      Patchwork<br><small>Social Messaging App</small>
    </a>
      <a class="topnav-item " href="https://handbook.scuttlebutt.nz/guides/ssb-server/install" title="Scuttlebot">
      Scuttlebot<br><small>P2P Log Store</small>
    </a>
      <a class="topnav-item selected" href="/docs" title="Documentation">
      Documentation<br><small>APIs, Articles</small>
    </a>
    </div>
  </div>
      <div id="layout">
        <div id="leftnav">
      <div class="leftnav-item">Key Concepts</div>
      <div class="leftnav-subitems">
        <div class="leftnav-item ">
      <a href="/scuttlebutt-protocol-guide" title="Secure Scuttlebutt: a global database protocol">Secure Scuttlebutt: a global database protocol</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/ssb/linking.html" title="Content-Hash Linking">Content-Hash Linking</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/ssb/secret-handshake.html" title="Secret Handshake: a secure channel protocol">Secret Handshake: a secure channel protocol</a>
    </div>
        <div class="leftnav-item selected">
      <a href="/docs/ssb/end-to-end-encryption.html" title="Private Box: metadata-free encryption">Private Box: metadata-free encryption</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/ssb/faq.html" title="Frequently Asked Questions">Frequently Asked Questions</a>
    </div>
      </div>
      <div class="leftnav-item">API Documentation</div>
      <div class="leftnav-subitems">
        <div class="leftnav-item ">
      <a href="https://github.com/ssbc/ssb-server" title="scuttlebot">scuttlebot</a>
    </div>
        <div class="leftnav-indent">
          <div class="leftnav-item ">
      <a href="https://scuttlebot.io/apis/scuttlebot/blobs.html" title="blobs">blobs</a>
    </div>
          <div class="leftnav-item ">
      <a href="https://github.com/ssbc/ssb-friends" title="friends">friends</a>
    </div>
          <div class="leftnav-item ">
      <a href="https://github.com/ssbc/ssb-gossip" title="gossip">gossip</a>
    </div>
          <div class="leftnav-item ">
      <a href="https://github.com/ssbc/ssb-invite" title="invite">invite</a>
    </div>
          <div class="leftnav-item ">
      <a href="https://github.com/ssbc/ssb-private" title="private">private</a>
    </div>
          <div class="leftnav-item ">
      <a href="https://github.com/ssbc/ssb-replicate" title="replicate">replicate</a>
    </div>
        </div>
        <div class="leftnav-item ">
      <a href="/ssb-client" title="ssb-client">ssb-client</a>
    </div>
        <div class="leftnav-item ">
      <a href="/ssb-feed" title="ssb-feed">ssb-feed</a>
    </div>
        <div class="leftnav-item ">
      <a href="/ssb-keys" title="ssb-keys">ssb-keys</a>
    </div>
        <div class="leftnav-item ">
      <a href="/ssb-msgs" title="ssb-msgs">ssb-msgs</a>
    </div>
        <div class="leftnav-item ">
      <a href="/ssb-msg-schemas" title="ssb-msg-schemas">ssb-msg-schemas</a>
    </div>
        <div class="leftnav-item ">
      <a href="/ssb-ref" title="ssb-ref">ssb-ref</a>
    </div>
        <div class="leftnav-item ">
      <a href="/ssb-markdown" title="ssb-markdown">ssb-markdown</a>
    </div>
        <div class="leftnav-item ">
      <a href="/patchwork-threads" title="patchwork-threads">patchwork-threads</a>
    </div>
        <div class="leftnav-item ">
      <a href="/ssb-config" title="ssb-config">ssb-config</a>
    </div>
        <div class="leftnav-item ">
      <a href="/secret-stack" title="secret-stack">secret-stack</a>
    </div>
        <div class="leftnav-item ">
      <a href="/muxrpc" title="muxrpc">muxrpc</a>
    </div>
        <div class="leftnav-item ">
      <a href="/muxrpcli" title="muxrpcli">muxrpcli</a>
    </div>
        <div class="leftnav-item ">
      <a href="/mdmanifest" title="mdmanifest">mdmanifest</a>
    </div>
        <div class="leftnav-item ">
      <a href="/docs/api/pull-stream.html" title="pull-stream">pull-stream</a>
    </div>
      </div>
    </div>
        <div id="content">
          <h1 id="private-box">Private-box</h1>
<p>Private-box is a format for encrypting a private message to many parties.
It is designed according to the <a href="https://github.com/crypto-browserify/crypto-browserify/issues/128">audit-driven crypto design process</a>.
You can <strong><a href="https://github.com/auditdrivencrypto/private-box">find the repository on GitHub</a></strong>.</p>
<h2 id="properties">Properties</h2>
<p>This protocol was designed for use with secure-scuttlebutt.
In this place, messages are placed in public, and the sender is known via a signature,
but we can hide the recipient and the content.</p>
<h5 id="recipients-are-hidden-"><strong>Recipients are hidden.</strong></h5>
<p>An eaves-dropper cannot know the recipients or their number.
Since the message is encrypted to each recipient, and then placed in public,
to receive a message you will have to decrypt every message posted.
This would not be scalable if you had to decrypt every message on the internet,
but if you can restrict the number of messages you might have to decrypt,
then it&#39;s reasonable. For example, if you frequented a forum which contained these messages,
then it would only be a reasonable number of messages, and posting a message would only
reveal that you where talking to some other member of that forum.</p>
<p>Hiding access to such a forum is another problem that&#39;s out of the current scope.</p>
<h5 id="the-number-of-recipients-are-hidden-"><strong>The number of recipients are hidden.</strong></h5>
<p>If the number of recipients was not hidden, then sometimes it would be possible
to deanonymise the recipients, if there was a large group discussion with
an unusual number of recipients. Encrypting the number of recipients means that,
when a message is not encrypted to you, you will attempt to decrypt same number of times
as the maximum recipients.</p>
<h5 id="a-valid-recipient-does-not-know-the-other-recipients-"><strong>A valid recipient does not know the other recipients.</strong></h5>
<p>A valid recipient knows the number of recipients but now who they are.
This is more a sideeffect of the design than an intentional design element.
The plaintext contents may reveal the recipients, if needed.</p>
<h5 id="by-providing-the-key-for-a-message-an-outside-party-could-decrypt-the-message-"><strong>By providing the key for a message, an outside party could decrypt the message.</strong></h5>
<p>When you tell someone a secret you must trust them not to reveal it.
Anyone who knows the key could reveal that to some other party who could then read the message content,
but not the recipients (unless the sender revealed the ephemeral secret key).</p>
<h2 id="assumptions">Assumptions</h2>
<p>Messages will be posted in public, so that the sender is likely to be known,
and everyone can read the messages. (This makes it possible to hide the recipient,
but probably not the sender.)</p>
<p>Resisting traffic analysis of the timing or size of messages is out of scope of this spec.</p>
<h2 id="prior-art">Prior Art</h2>
<h4 id="pgp"><strong>PGP</strong></h4>
<p>In PGP the recipient, the sender, and the subject are sent as plaintext.
If the recipient is known, then the metadata graph of who is communicating with who can be read,
which, since it is easier to analyze than the content, is important to protect.</p>
<h4 id="sodium-seal"><strong>Sodium seal</strong></h4>
<p>The Sodium library provides a <em>seal</em> function that generates an ephemeral keypair,
derives a shared key to encrypt a message, and then sends the ephemeral public key and the message.
The recipient is hidden, and it is forward secure if the sender throws out the ephemeral key.
However, it&#39;s only possible to have one recipient.</p>
<h4 id="minilock"><strong>Minilock</strong></h4>
<p>Minilock uses a similar approach to <code>private-box</code> but does not hide the
number of recipients. In the case of a group discussion where multiple rounds
of messages are sent to everyone, this may enable an eavesdropper to deanonymize
the participiants of a discussion if the sender of each message is known.</p>
<h2 id="api">API</h2>
<h4 id="encrypt-plaintext-buffer-recipients-arraycurve25519_pk-"><strong>encrypt (plaintext Buffer, recipients Array&lt;curve25519_pk&gt;)</strong></h4>
<p>Takes a plaintext buffer of the message you want to encrypt,
and an array of recipient public keys.
Returns a message that is encrypted to all recipients
and openable by them with <code>PrivateBox.decrypt</code>.
The recipients must be between 1 and 7 items long.</p>
<p>The encrypted length will be <code>56 + (recipients.length * 33) + plaintext.length</code> bytes long,
between 89 and 287 bytes longer than the plaintext.</p>
<h4 id="decrypt-ciphertext-buffer-secretkey-curve25519_sk-"><strong>decrypt (ciphertext Buffer, secretKey curve25519_sk)</strong></h4>
<p>Attempt to decrypt a private-box message, using your secret key.
If you where an intended recipient then the plaintext will be returned.
If it was not for you, then <code>undefined</code> will be returned.</p>
<h2 id="protocol">Protocol</h2>
<h4 id="encryption"><strong>Encryption</strong></h4>
<p>Private-box generates:</p>
<ul>
<li><code>ephemeral</code>: an ephemeral curve25519 keypair that will only be used with this message.</li>
<li><code>body_key</code>: a random key that will be used to encrypt the plaintext body.</li>
</ul>
<p>First, private-box outputs the ephemeral public key, then multiplies each recipient public key
with its secret to produce ephemeral shared keys (<code>shared_keys[1..n]</code>).
Then, private-box concatenates <code>body_key</code> with the number of recipients,
encrypts that to each shared key, and concatenates the encrypted body.</p>
<pre><code>function encrypt (plaintext, recipients) {
  var ephemeral = keypair()
  var nonce     = random(24)
  var body_key  = random(32)
  var body_key_with_length = concat([body_key, recipients.length])
  return concat([
    nonce,
    ephemeral.publicKey,
    concat(recipients.map(function (publicKey) {
      return secretbox(
        body_key_with_length,
        nonce,
        scalarmult(publicKey, ephemeral.secretKey)
      )
    }),
    secretbox(plaintext, nonce, body_key)
  ])
}
</code></pre><h4 id="decryption"><strong>Decryption</strong></h4>
<p><code>private-box</code> takes the nonce and ephemeral public key,
multiplies that with your secret key, then tests each possible
recipient slot until it either decrypts a key or runs out of slots.
If it runs out of slots, the message was not addressed to you,
so <code>undefined</code> is returned. Else, the message is found and the body
is decrypted.</p>
<pre><code class="lang-js">function decrypt (ciphertext, secretKey) {
  var next = reader(ciphertext) // next() will read the passed N bytes
  var nonce = next(24)
  var publicKey = next(32)
  var sharedKey = salarmult(publicKey, secretKey)

  for(var i = 0; i &lt; 7; i++) {
    var maybe_key = next(33)
    var key_with_length = secretbox_open(maybe_key, nonce, sharedKey)
    if (key_with_length) { // decrypted!
      var key = key_with_length.slice(0, 32)
      var length = key_with_length[32]
      return secretbox_open(
        key,
        ciphertext.slice(56 + 33*(length+1), ciphertext.length),
      )
    }
  }
  // this message was not addressed to the owner of secretKey
  return undefined
}
</code></pre>
<h2 id="license">License</h2>
<p>MIT</p>

        </div>
      </div>
    </body>
  </html>